name: OpenTrade CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '20'

jobs:
  # ============ 安全扫描 ============
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install safety
        run: pip install safety
      
      - name: Run safety scan
        run: |
          safety check -r requirements.txt --json > safety_report.json || true
          safety check -r requirements.txt --exit-code 0
      
      - name: Check for known vulnerabilities
        run: |
          if [ -f safety_report.json ]; then
            vulnerabilities=$(cat safety_report.json | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('vulnerabilities_found', [])))")
            if [ "$vulnerabilities" != "0" ]; then
              echo "⚠️ Found $vulnerabilities vulnerabilities"
              cat safety_report.json
              exit 1
            fi
          fi

  # ============ 依赖版本锁定检查 ============
  dependency-lock-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Check pyproject.toml exists
        run: |
          if [ ! -f pyproject.toml ]; then
            echo "❌ pyproject.toml not found"
            exit 1
      
      - name: Check dependencies are pinned
        run: |
          # 检查是否有非固定版本的依赖
          unpinned=$(grep -E "^[a-zA-Z-]+\s*=" pyproject.toml | grep -v "version" | wc -l)
          if [ "$unpinned" != "0" ]; then
            echo "⚠️ Found $unpinned potentially unpinned dependencies"
          fi

  # ============ 代码格式检查 ============
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Black
        run: pip install black isort
      
      - name: Run Black
        run: |
          black --check opentrade/ || echo "⚠️ Black formatting issues found"
      
      - name: Run isort
        run: |
          isort --check-only opentrade/ || echo "⚠️ Import sorting issues found"
      
      - name: Check for debug statements
        run: |
          debug_count=$(grep -r "print(" opentrade/*.py opentrade/*/*.py 2>/dev/null | grep -v "# " | wc -l)
          if [ "$debug_count" != "0" ]; then
            echo "⚠️ Found $debug_count print statements (should use logging)"
          fi

  # ============ 前端代码检查 ============
  frontend-lint:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          cd frontend && npm install
      
      - name: Run ESLint
        run: |
          cd frontend && npx eslint src/ --ext .ts,.tsx || echo "⚠️ ESLint issues found"

  # ============ 单元测试 ============
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          pip install -e .
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=opentrade --cov-report=xml --cov-report=term-missing || true
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ============ 测试覆盖率门禁 ============
  coverage-gate:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - name: Check coverage
        run: |
          if [ -f coverage.xml ]; then
            coverage=$(grep -oP '(?<=line-rate=")[^"]*' coverage.xml)
            coverage_percent=$(echo "$coverage * 100" | bc | cut -d. -f1)
            echo "Coverage: $coverage_percent%"
            if [ "$coverage_percent" -lt 80 ]; then
              echo "❌ Coverage $coverage_percent% below 80% threshold"
              exit 1
            fi
            echo "✅ Coverage $coverage_percent% meets 80% threshold"
          else
            echo "⚠️ No coverage report found"
          fi

  # ============ 类型检查 ============
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install mypy
        run: pip install mypy
      
      - name: Run mypy
        run: |
          mypy opentrade/ --ignore-missing-imports || echo "⚠️ Type checking issues found"

  # ============ 构建与发布 ============
  build:
    needs: [security-scan, lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build package
        run: |
          pip install build
          python -m build
      
      - name: Verify build
        run: |
          ls -la dist/
          pip install dist/*.whl --force-reinstall

  # ============ Docker 构建 ============
  docker-build:
    needs: [security-scan, lint]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: opentrade/opentrade:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============ 发布到 PyPI ============
  publish-pypi:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install publish package
        run: pip install build
      
      - name: Build and publish to PyPI
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          python -m build
          twine upload dist/*

# ============ 通知 ============
notifications:
  runs-on: ubuntu-latest
  needs: [security-scan, lint, unit-tests, build]
  if: always()
  steps:
    - name: Send notification on failure
      if: failure()
      run: |
        echo "❌ CI/CD pipeline failed"
        # 可以添加 Slack/Discord 通知
